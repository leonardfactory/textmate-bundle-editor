var async	= require('async');
var path	= require('path');
var fs		= require('fs');
var errory	= require('errory');
var wrench 	= require('wrench'),
    util 	= require('util'),
	Lister	= require('lister');
	Folder	= require('folder');

module.exports = Loader = function(bundle_list)
{
	var self = {};
	
	self.bundle_list = null;
	self.folder = null;
	self.lister = null;
	self.fn = null;
	
	self.build = function () 
	{
		self.bundle_list = bundle_list;
	}
	
	self.loadBundle = function(bundle_path)
	{	
		async.waterfall ([
			function (callback)
			{
				fs.stat(bundle_path, callback);
			},
			function (stat, callback) 
			{
				callback(stat.isDirectory() ? null : 'Cannot read directory');
			},
			function (callback)
			{
				callback(path.extname(bundle_path) === '.tmbundle' ? null : 'Selected file is not a bundle!');
			},
			function (callback)
			{
				self.folder = Folder(bundle_path);
				self.lister	= Lister(self.folder);
				self.fn(self.lister.buildList());
			}
		], 
		errory.handler);	
	}
	
	self.onBundleLoaded = function(fn)
	{
		self.fn = fn;
	}
	
	self.build();
	return self;
}